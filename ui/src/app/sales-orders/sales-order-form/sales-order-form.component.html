<div class="feature-header">
  <p>
    <label>Atualize os pedidos de venda através do formulário abaixo.</label>
  </p>
  <div class="actions">
    <a routerLink="/sales-orders"><button pButton type="button" class="ui-button-secondary" label="Voltar"></button></a>
    <button (click)="submitSalesOrder()" pButton type="button" label="Salvar"></button>
  </div>
</div>
<p-card>
  <form [formGroup]="formFields" (ngSubmit)="submitSalesOrder()" *ngIf="!loading">
    <div class="p-fluid p-formgrid p-grid">
      <div class="p-field p-col-6">
        <label for="referenceCode">Referência</label>
        <input
          id="referenceCode"
          name="referenceCode"
          type="text"
          formControlName="referenceCode"
          pInputText
          placeholder="ex. 123456789"
        />
      </div>
      <div class="p-field p-col-6">
        <label for="name">Cliente</label>
        <p-autoComplete
          formControlName="customer"
          [suggestions]="customers"
          (completeMethod)="search($event)"
          [multiple]="false"
          field="name"
          placeholder="Selecione um cliente"
        >
          <ng-template let-customer pTemplate="item">
            <div>{{ customer.name }} ({{ customer.cpf }})</div>
          </ng-template>
        </p-autoComplete>
      </div>
      <div class="p-field p-col-3">
        <label for="total">Total</label>
        <input type="text" pInputText disabled [value]="salesOrder.total || 0 | reais" />
      </div>
      <div class="p-field p-col-3">
        <label for="name">Forma de Pagamento</label>
        <p-dropdown
          [options]="paymentTypes"
          formControlName="paymentType"
          placeholder="Selecione uma forma de pagamento"
          [showClear]="true"
        ></p-dropdown>
      </div>
      <div class="p-field p-col-3">
        <label for="name">Status de Pagamento</label>
        <p-dropdown
          [options]="paymentStatus"
          formControlName="paymentStatus"
          placeholder="Selecione um status de pagamento"
          [showClear]="true"
        ></p-dropdown>
      </div>
      <div class="p-field p-col-3">
        <label for="installments">Parcelas</label>
        <p-dropdown [options]="installments" formControlName="installments"></p-dropdown>
      </div>
    </div>
  </form>
</p-card>
<div style="margin-top: 20px;">
  <p-card>
    <div class="product-variation-description">
      <p>Selecione os produtos a serem vendidos.</p>
      <button pButton label="Adicionar Item" (click)="addItem()"></button>
    </div>
    <form [formGroup]="formFields" (ngSubmit)="submitSalesOrder()" *ngIf="!loading">
      <div class="p-fluid p-grid">
        <div class="p-col-5">
          <label>Produto</label>
        </div>
        <div class="p-col-2">
          <label>Preço</label>
        </div>
        <div class="p-col-2">
          <label>Desconto</label>
        </div>
        <div class="p-col-2">
          <label>Quantidade</label>
        </div>
      </div>
      <div formArrayName="items" *ngFor="let item of items.controls; let i = index">
        <div [formGroupName]="i" class="p-fluid p-formgrid p-grid">
          <div class="p-field p-col-5">
            <p-autoComplete
              formControlName="productVariation"
              [suggestions]="productVariations"
              (completeMethod)="searchProductVariations($event)"
              (onSelect)="selectProductVariation($event, i)"
              [multiple]="false"
              field="title"
              placeholder="Selecione um produto"
            >
              <ng-template let-productVariation pTemplate="item">
                <div>{{ productVariation.sku }} - {{ productVariation.title }}</div>
              </ng-template>
            </p-autoComplete>
          </div>
          <div class="p-field p-col-2">
            <input
              type="text"
              placeholder="Ex. R$ 119,90"
              pInputText
              disabled
              [value]="item.get('price').value || 0 | reais"
            />
          </div>
          <div class="p-field p-col-2">
            <input
              [name]="'discount' + i"
              type="number"
              formControlName="discount"
              pInputText
              placeholder="ex. R$ 10,00"
              (blur)="updatePrice()"
              (change)="updatePrice()"
            />
          </div>
          <div class="p-field p-col-2">
            <input
              [name]="'amount' + i"
              type="number"
              formControlName="amount"
              pInputText
              placeholder="ex. 3"
              (blur)="updatePrice()"
              (change)="updatePrice()"
            />
          </div>
          <div class="p-field p-col-1">
            <button
              pButton
              label="Remover"
              class="ui-button-danger"
              style="width: 100%;"
              (click)="removeItem(i)"
            ></button>
          </div>
        </div>
      </div>
    </form>
  </p-card>
</div>
